#!/bin/sh

# dmenu wrapper for fzf

if [ -n "$SSH_CLIENT" ] || [ -n "$SSH_TTY" ]; then
	unset FZF_DEFAULT_OPTS
	for i in "$@" ; do case "$i" in
		-b) export FZF_DEFAULT_OPTS="$FZF_DEFAULT_OPTS --layout=default" ; shift ;;
		-i) export FZF_DEFAULT_OPTS="$FZF_DEFAULT_OPTS -i" ; shift ;;
		-p) prompt="$2" ; shift 2 ;;
		-f) shift ;;
		-nb) dmenu_nb="$2" ; shift 2 ;;
		-nf) dmenu_nf="$2" ; shift 2 ;;
		-sb) dmenu_sb="$2" ; shift 2 ;;
		-sf) dmenu_sf="$2" ; shift 2 ;;
		-[lmw]) shift 2 ;;
		-*) exit ;;
	esac done
	export FZF_DEFAULT_OPTS="--no-info --no-separator --no-scrollbar \
		--prompt=\"\" --gutter=\" \" --pointer=\"\" --ellipsis=\"\" \
		--preview-window=\"\" --highlight-line --no-hscroll --raw \
		--reverse +i --bind=change:best ${FZF_DEFAULT_OPTS# }"
	# dmenu keybinds
	export FZF_DEFAULT_OPTS="$FZF_DEFAULT_OPTS \
		--bind=tab:yank,ctrl-i:yank \
		--bind=ctrl-y:yank,ctrl-Y:yank \
		--bind=enter:accept \
		--bind=ctrl-j:accept,ctrl-J:accept \
		--bind=ctrl-m:accept,ctrl-M:accept \
		--bind=esc:abort,ctrl-c:abort,ctrl-g:abort \
		--bind=ctrl-left:backward-word,alt-b:backward-word \
		--bind=ctrl-right:forward-word,alt-f:forward-word \
		--bind=ctrl-a:first,alt-g:first \
		--bind=ctrl-b:up,ctrl-p:up,alt-h:up \
		--bind=ctrl-d:delete-char \
		--bind=ctrl-e:last,alt-G:last \
		--bind=ctrl-f:down,ctrl-n:down,alt-l:down
		--bind=ctrl-h:backward-delete-char \
		--bind=ctrl-k:kill-word \
		--bind=ctrl-u:kill-line \
		--bind=ctrl-w:backward-kill-word \
		--bind=alt-j:page-down \
		--bind=alt-k:page-up"
	# wal colors
	wal_dmenu="${XDG_CACHE_DIR:-$HOME/.cache}/wal/colors-wal-dmenu.h"
	if [ -f "$wal_dmenu" ]; then
		dmenu_nb="${dmenu_nb:-$(grep "SchemeNorm" "$wal_dmenu" | cut -d'"' -f4)}"
		dmenu_nf="${dmenu_nf:-$(grep "SchemeNorm" "$wal_dmenu" | cut -d'"' -f2)}"
		dmenu_sb="${dmenu_sb:-$(grep "SchemeSel" "$wal_dmenu" | cut -d'"' -f4)}"
		dmenu_sf="${dmenu_sf:-$(grep "SchemeSel" "$wal_dmenu" | cut -d'"' -f2)}"
		out_bg="$(grep "SchemeOut" "$wal_dmenu" | cut -d'"' -f4)"
		out_fg="$(grep "SchemeOut" "$wal_dmenu" | cut -d'"' -f2)"
	fi
	# dmenu colors
	export FZF_DEFAULT_OPTS="$FZF_DEFAULT_OPTS \
		--color=list-fg:${dmenu_nf:-#bbbbbb},hl:${dmenu_nf:-#bbbbbb} \
		--color=prompt:${dmenu_nf:-#bbbbbb}:regular \
		--color=nomatch:regular \
		--color=list-bg:${dmenu_nb:-#222222} \
		--color=fg+:${dmenu_sf:-#eeeeee},hl+:${dmenu_sf:-#eeeeee} \
		--color=bg+:${dmenu_sb:-#005577} \
		--color=marker:${out_bg:-#00ffff}"

	[ "${0##*/}" = "dmenu_run" ] && { echo -n "$PATH" | xargs -d : -I {} find {} -maxdepth 1 -executable -type f -printf "%P\n" | sort -u | fzf | xargs setsid -f >/dev/null 2>&1 ; exit ;}

	fzf --prompt="$prompt" "$@"
else
	"$PREFIX"/bin/dmenu "$@"
fi
